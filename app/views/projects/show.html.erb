<% content_for:head do%>

  
  <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
  <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.22/css/jquery.dataTables.css">

  <script type="text/javascript">
    //debugger
    console.log("=========")
    $(window).unload(function() {
      $.rails.enableFormElements($($.rails.formSubmitSelector));
    });
  
    $.fn.dataTable.ext.errMode = 'throw';

    $(document).ready( function () { 
      var table = $('#Table').DataTable({
        columnDefs: [{
          targets: [0, -1],
          orderable: false,
        }],
        scrollX: true
      }); 

      $('button.toggle-vis').on( 'click', function (e) {
        e.preventDefault();
        $(this).toggleClass('clicked');
        // Get the column API object
        var column = table.column( $(this).attr('data-column') );
        // Toggle the visibility
        column.visible( ! column.visible() );
    } );



  } );

    

    function toggle_checkall(field_name, state) {
      var checkboxes = document.getElementsByTagName('input');
      var count = checkboxes.length;
      for (var i = 0; i < count; i++) {
        if (checkboxes[i].type == "checkbox"
            && checkboxes[i].name == field_name + "_ids[]") {
          checkboxes[i].checked = state;
        }
      }
    }
  </script>
<%end%>

<div class="container">
  <h1>
    Project Information
  </h1>
  <%= link_to 'Edit', edit_project_path(@project) %> 
  <%= link_to 'Back', projects_path %>
  <br/>

  <p>
    <strong>Name:</strong>
    <%= @project.name %>
  </p>
  
  <p>
    <strong>Publication:</strong>
    <%= @project.related_publications %>
  </p>

  <p>
    <strong>Num:</strong>
    <%= @project.num_of_samples %>
  </p>


  <br />

  <h2>Samples</h2>
  <p>
    <span class="download_span">
      Download samples information:
      <%= link_to "Metadata", project_path(format: "csv") %>
    </span>
  </p>

  <div id='hidden_helper'>
    Hide columns: 
    <br />
    <% i=1 %>
    <% @sample_attrs.each do |attr| %>
      <% if attr != 'id' && attr != 'created_at' && attr != 'updated_at' %>
        <button class="toggle-vis" data-column='<%=i.to_s%>'> 
          <%= attr.capitalize %>
        </button>
        <%i += 1%>
      <%end%>
    <%end%>
  </div>

  <%= form_tag make_selected_file_project_samples_path(@project), multipart: true do %>  
    <table id="Table" class="display">

      <thead>
        <th>
          <input type="checkbox" onclick="toggle_checkall('sample', this.checked);" />
        </th>
        <% @sample_attrs.each do |attr| %>
          <% if attr != 'id' && attr != 'created_at' && attr != 'updated_at' %>
            <th> <%= attr.capitalize %> </th>
          <% end %>
        <% end %>
        <th>Action</th>
      </thead>

      <tbody>
        <% @project.samples.each do |sample| %>
        
          <tr>
            <td><%= check_box_tag "sample_ids[]", sample.id %></td>
            <% @sample_attrs.each do |attr| %>
              <% if attr != 'id' && attr != 'created_at' && attr != 'updated_at' %>
                <td> 
                  <div class="table_cell"> 
                    <%= sample[attr] %> 
                  </div>
                </td>
              <% end %>
            <% end %>
            
            <td>
              <%= link_to 'Show', project_sample_path(sample.project, sample) %>
              <%#= link_to 'Delete', [sample.project, sample],
                method: :delete,
                data: { confirm: 'Are you sure to delete ' + sample.sample_name + '?'} %>
              <%#= link_to 'Edit', edit_project_sample_path(sample.project, sample.id) %> 
            </td>
          </tr>
        
        <% end %>
      </tbody>

    </table>



    <%= submit_tag "dowload selected samples metadata to file", :name => 'metadata', :class => "s_table_sub" %>
    <%= submit_tag "download selected samples abundance to file", :name => 'abundance', :class => "s_table_sub"  %>
    <%#= submit_tag "download selected samples sequence to file", :name => 'sequence' %>
    <br />
    
    <%= submit_tag "export selected metadata to", :name => 'metadata2ds', :class => "s_table_sub"  %>
    <%= submit_tag "export selected abundance to", :name => 'abd2ds', :class => "s_table_sub"  %>
    <select id="select_box" name="ds_selected">
      <option value="">--Please choose a dataset--</option>
      <% @datasets.each do |ds|%>
        <option value=<%=ds.name%>> <%=ds.name%></option>
      <%end%>
    </select>
  <% end %>
  <p>
    If you do NOT have any dataset, create one here: 
    <%=link_to 'Create new dataset', new_user_dataset_path(:user_id=>@user.id)%>
  </p>

  <p>
    *To avoid frenquent download, please refresh the page to enable download again.
  </p>



  <%#=link_to 'Download selected sequencing data', download_selected_abd_project_samples_path(@project.id) %>

  <%#= form_tag import_project_samples_path([@project]), multipart: true do %>
    <%#= file_field_tag :file %>
    <%#= submit_tag "Import metadata by csv" %>
  <%# end %>

  <%#= form_tag import_abd_table_project_samples_path([@project]), multipart: true do %>
    <%#= file_field_tag :file %>
    <%#= submit_tag "Import abundance by tsv" %>
  <%# end %>

</div>


